<html>
  <head>
    <title>Танчики</title>
    <style>
      body { margin: 0; }
      canvas { width: 100%; height: 100% }
      #info {
        position: absolute;
        top: 10px;
        width: 100%;
        text-align: center;
        z-index: 100;
        display:block;
        color: red;
        font-weight: bold;
        font-size: 30px;
      }
    </style>
  </head>
  <body>
    <div id="info">Танчики</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/90/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js" integrity="sha256-/GKyJ0BQJD8c8UYgf7ziBrs/QgcikS7Fv/SaArgBcEI=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="./channels.js"></script>
    <script type="text/javascript" src="./3d_objects.js"></script>
    <!--<script type="text/javascript" src="./geometry.js"></script>-->
    <script type="text/javascript" src="./actors/rotating_tank.js"></script>
    <script type="text/javascript" src="./actors/tank.js"></script>
    <script type="text/javascript" src="./actors/shots.js"></script>

    <script type="text/javascript">
      function create3DScene(){
        let scene = new THREE.Scene();
        let camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );

        let renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        camera.position.z = 17;

        var light = new THREE.PointLight(0xFFFF00);
        /* position the light so it shines on the cube (x, y, z) */
        light.position.set(10, 0, 25);
        light.castShadow = true;
        light.shadow.mapSize.width = 1024;
        light.shadow.mapSize.height = 1024;
        scene.add(light);

        return [renderer, scene, camera]
      }
    </script>

    <script type="text/javascript">
      async function runGame(){
        runShots(borders)
        runShots2(borders)

        let redTank = new Tank({
          color: 0x990099,
          speed: 1,
          startX: 10,
          startY: 0,
          borders: borders,
        })
        redTank.run()


        let yiellowTank = new Tank({
          color: 0xeeee00,
          speed: 1,
          startX: -10,
          startY: 0,
          borders: borders,
        })
        yiellowTank.run()

        while(true){
          let event = await window.keydownChannel.promise

          if (event.keyCode == '38') {
            redTank.channel.push({slug: 'rotate', direction: 'up'})
          } else if (event.keyCode == '40') {
            redTank.channel.push({slug: 'rotate', direction: 'down'})
          } else if (event.keyCode == '37') {
            redTank.channel.push({slug: 'rotate', direction: 'left'})
          } else if (event.keyCode == '39') {
            redTank.channel.push({slug: 'rotate', direction: 'right'})
          } else if (event.keyCode == '32') {
            redTank.channel.push({slug: 'move'})
          }

          if (event.keyCode == '87') {
            yiellowTank.channel.push({slug: 'rotate', direction: 'up'})
          }
          else if (event.keyCode == '83') {
            yiellowTank.channel.push({slug: 'rotate', direction: 'down'})
          }
          else if (event.keyCode == '65') {
            yiellowTank.channel.push({slug: 'rotate', direction: 'left'})
          }
          else if (event.keyCode == '68') {
            yiellowTank.channel.push({slug: 'rotate', direction: 'right'})
          }
          else if (event.keyCode == '192') {
            yiellowTank.channel.push({slug: 'move'})
          }
        }


      }
    </script>

    <script>
      var [renderer, scene, camera] = create3DScene()
      document.body.appendChild( renderer.domElement );

      var borders = {
        leftX: -13,
        rightX: 13,
        topY: 6,
        bottomY: -7,
      }
      let border3D = createBattleField3D(borders)
      scene.add(border3D);

      window.animationChannel = new Channel(requestAnimationFrame)
      window.keydownChannel = new Channel()

      document.onkeydown = (event)=>{
        event = event || window.event;

        console.log('onkeydown key', event.key)
        console.log('onkeydown keyCode', event.keyCode)

        window.keydownChannel.push(event)
      }


      async function render(){
        while(true){
          renderer.render(scene, camera);
          await animationChannel.promise
        }
      }

      // runRotatingTank()
      render()
      runGame()
    </script>
  </body>
</html>

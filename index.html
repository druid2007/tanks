<html>
  <head>
    <title>Танчики</title>
    <style>
      body { margin: 0; }
      canvas { width: 100%; height: 100% }
      #info {
        position: absolute;
        top: 10px;
        width: 100%;
        text-align: center;
        z-index: 100;
        display:block;
        color: red;
        font-weight: bold;
        font-size: 30px;
      }
    </style>
  </head>
  <body>
    <div id="info">Танчики</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/90/three.min.js"></script>
    <script>
      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );

      var renderer = new THREE.WebGLRenderer();
      renderer.setSize( window.innerWidth, window.innerHeight );
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;

      document.body.appendChild( renderer.domElement );

      // //create a group and add the two cubes
      // //These cubes can now be rotated / scaled etc as a group
      function createTank(){
        var tank = new THREE.Group();

        var geometry = new THREE.BoxGeometry( 1, 0.9, 0.3 );
        var material = new THREE.MeshPhongMaterial({color: 0x00aa00, vertexColors: THREE.FaceColors});
        var body = new THREE.Mesh( geometry, material );
        body.position.z = 0.1
        body.castShadow = true;
        body.receiveShadow = true;
        tank.add( body );

        var sphere = new THREE.SphereGeometry(0.3, 8, 4, 0, 6.3, 0, 1.3); // https://threejs.org/docs/#api/geometries/SphereGeometry
        var turret = new THREE.Mesh( sphere, new THREE.MeshPhongMaterial({color: 0x00ee00}) );
        turret.rotation.x = Math.PI / 2
        turret.position.z = 0.2
        turret.castShadow = true;
        turret.receiveShadow = true;
        tank.add( turret );

        var geometry2 = new THREE.BoxGeometry( 1, 0.1, 0.1 );
        var material2 = new THREE.MeshPhongMaterial({color: 0x00ee00, vertexColors: THREE.FaceColors});
        var gun = new THREE.Mesh( geometry2, material2 );
        gun.position.x = -0.5
        gun.position.z = 0.3
        gun.castShadow = true;
        gun.receiveShadow = true;
        tank.add( gun );

        var geometry3 = new THREE.BoxGeometry( 1.15, 0.2, 0.3 );
        var material3 = new THREE.MeshPhongMaterial({color: 0xaaaaaa, vertexColors: THREE.FaceColors});
        var truck1 = new THREE.Mesh( geometry3, material3 );
        truck1.position.y = 0.4
        tank.add( truck1 );

        var geometry4 = new THREE.BoxGeometry( 1.15, 0.2, 0.3 );
        var material4 = new THREE.MeshLambertMaterial({color: 0xaaaaaa, vertexColors: THREE.FaceColors});
        var truck2 = new THREE.Mesh( geometry4, material4 );
        truck2.position.y = -0.4
        tank.add( truck2 );
        return tank
      }

      let tank = createTank()
      scene.add( tank );

      let tank2 = createTank()
      scene.add( tank2 );

      var borderMaterial = new THREE.LineBasicMaterial( { color: 0xffffff, linewidth: 2 } );
      var borderGeometry = new THREE.Geometry();
      var leftX = -13;
      var rightX = 13;
      var topY = 6;
      var bottomY = -7;
      borderGeometry.vertices.push(new THREE.Vector3( leftX, topY, 0) );
      borderGeometry.vertices.push(new THREE.Vector3( rightX, topY, 0) );
      borderGeometry.vertices.push(new THREE.Vector3( rightX, bottomY, 0) );
      borderGeometry.vertices.push(new THREE.Vector3( leftX, bottomY, 0) );
      borderGeometry.vertices.push(new THREE.Vector3( leftX, topY, 0) );
      var border = new THREE.Line( borderGeometry, borderMaterial );
      scene.add( border );

      camera.position.z = 17;

      var light = new THREE.PointLight(0xFFFF00);
      /* position the light so it shines on the cube (x, y, z) */
      light.position.set(10, 0, 25);
      light.castShadow = true;
      light.shadow.mapSize.width = 1024;
      light.shadow.mapSize.height = 1024;
      scene.add(light);

      var animate = function () {

        tank2.rotation.x += 0.01;
        tank2.rotation.y += 0.05;

        renderer.render(scene, camera);

        // Loop
        requestAnimationFrame( animate );
      };

      animate();

      document.onkeydown = checkKey;

      var speed = 0.5;
      var stepX = -speed;
      var stepY = 0;
      function checkKey(e) {

          e = e || window.event;

          console.log('e.key', e.key)
          console.log('e.keyCode', e.keyCode)
          if (e.keyCode == '38') {
            // up
            tank.rotation.z = -Math.PI /2 ;
            stepX = 0;
            stepY = speed;
          }
          else if (e.keyCode == '40') {
            // down
            tank.rotation.z = Math.PI /2 ;
            stepX = 0;
            stepY = -speed;
          }
          else if (e.keyCode == '37') {
            // left
            tank.rotation.z = 0;
            stepX = -speed;
            stepY = 0;
          }
          else if (e.keyCode == '39') {
            tank.rotation.z = Math.PI;
            // right
            stepX = speed;
            stepY = 0;
          }
          else if (e.keyCode == '32') {
            // space
            console.log('stepX', stepX, 'stepY', stepY)
            tank.position.x += stepX;
            tank.position.x = Math.max(leftX, tank.position.x)
            tank.position.x = Math.min(rightX, tank.position.x)
            tank.position.y += stepY;
            tank.position.y = Math.max(bottomY, tank.position.y)
            tank.position.y = Math.min(topY, tank.position.y)
            console.log('tank.position', tank.position)
          }

      }
    </script>
  </body>
</html>
